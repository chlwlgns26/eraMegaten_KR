# eramegatenからREPEATとCOUNTを安全に置き換えるパッチ+α

## 注意事項
 このパッチはバグ修正及び今後バグが起こりにくく変更をしています。
非常に大量のコード変更を行い、なおかつ新たな機能追加などは行っていません。そのためバリアント開発者、まとめパッチ開発者など以外の人は導入の必要がないパッチです。
起動チェックは行いました。ただし、修正箇所が多いため目視確認はしていますがすべての動作確認はできていません。
パッチ作者はすべての変更の内容が適切であることをチェックはしてはいますが不具合があれば報告お願いします。
REPEAT、COUNTの使用によってバグ、不具合が発生する可能性が高くなるのでこのパッチを取り込む際さらにREPEAT、COUNTの使用が非推奨である旨をREADMEに追記、またはコード規約を定めることを強く推奨します。

## 対象環境
eramegaten 0.309+修正6+Rev110+Rev113

## パッチの目的
 このパッチは http://jbbs.shitaraba.net/bbs/read.cgi/otaku/16783/1479563839/523-533 に類似する不具合を抑止することを目的とし、また、その過程で気付いたいくつかの処理（詳細は下記）の修正をするパッチです。
変数COUNTはグローバル変数であり、またREPEATブロックはループに伴って変数COUNTを操作します。
これらは変数COUNTを利用したループ内で意図せず再度利用することによってエラーを発生させる原因となるため、コードを書く際に書いている関数の呼び出し元が変数COUNTを使用していないことを確認する必要があります。
現在のEmueraではループを記述するためにREPEATブロックではなくFORブロックを使いローカル変数、ユーザー定義変数などグローバル変数COUNTと違い関数の外に影響されない安全な変数を用いることができます。
このことから、先にあげた不具合はグローバル変数COUNTとREPEATブロックを使用しないことで防ぐことができます。

## 変更内容
 eramegaten本体から変数COUNTとブロックREPEATの使用の一切を安全に置き換えた
あと、
+ 戦闘画面において、LINKAGE待機中など防御中でない待機状態にあるキャラがいる状態でそのキャラのターゲット選択ボタンに対応するユニコード文字を直接入力した場合ターゲット選択画面が表示されるバグを修正
+ 魔晶剣作成処理において、素体となる悪魔の忠誠度によって装備可能レベルを免除する処理が変数の指定ミスによって忠誠度を取得する際素体となる悪魔の番号ではなくCOUNTを用いて取得していたバグを修正

+ INFO.ERB@INPUT_CHARA_LISTの引数ARGS:1、キャラクターをリスト表示の表示の可否を判断する関数呼び出しにおいて、COUNTを用いてグローバル変数で状態を渡していたのをARGで渡すように変更
+ 調教関連/NTRJOUSHI.ERB@NTR_JOUSHI_1、上司が女を夜相手する場合の呼び出しの関数について、COUNTを用いてグローバル変数で状態を渡していたのをARGで渡すように変更
+ 調教関連/STSTEM_DAUGHTER.ERB@CHILD_GROWTH、子供成長汎用処理の関数について、COUNTを用いてグローバル変数で状態を渡していたのをARGで渡すように変更

+ 調教関連/PRINT_STATE.ERB@ARRANGE_CHARANAME、関数内でCOUNTを用いてグローバル変数で状態を渡しているが、処理の内容が不明瞭であること、呼び出しの実例を見ようとするも呼び出し元がCALLFORMの可能性も考えて探してすら見つからず修正のしようがなかったため削除
などを処理にもかかわったりついでだったりで修正

## 行った変更手続き
1. 指定したフォルダ内にあるテキストファイルから任意のパターンに合致する行を検索するツールを用いてERBフォルダ内のERBファイルからCOUNTとREPEAT、RENDの使用を探し一覧を作る
2. REPEATを利用しているものに関してはFOR LCOUNT,0,に機械的に置き換えを行い関数宣言に#DIM LCOUNTを加える　既に使われている関数についてはFOR LCOUNTの中でREPEATが使われてないか、REPEATの中でFOR LCOUNTが使われてないかチェックし適切にした
3. FOR COUNT:1など、ループのためにCOUNTが用いられている場合LCOUNT:1などに置き換える
4. そうでない使用についてできる限り名づけを行ったユーザー定義変数に置き換えるなどを行う

##ライセンス
　このパッチの更新内容についてパッチ作者は著作権および著作者人格権の行使は行わず、更新元となった箇所に対し著作権を持っている作者全員にパッチ作者の該当更新部分に対する著作権を行使する権利を譲渡します
